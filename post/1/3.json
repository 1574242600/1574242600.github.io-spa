{"info":{"title":"[php]实现b站登录","date":1577275200,"tags":"php"},"path":"./source/_posts/php-.md","content":"<blockquote>\n<p><a href=\"https://blog.kaaass.net/archives/947\">https://blog.kaaass.net/archives/947</a></p>\n</blockquote>\n<hr>\n<p>在网上无聊瞎逛时，找到了这位大佬的文章\n里面给出了ak，sk ，万分感激 </p>\n<!--more-->\n<pre><code><span class=\"hljs-attribute\">Device</span>: android\n<span class=\"hljs-attribute\">Description</span>: 普通版\n<span class=\"hljs-attribute\">AppKey</span>: <span class=\"hljs-number\">1</span>d<span class=\"hljs-number\">8</span>b<span class=\"hljs-number\">6</span>e<span class=\"hljs-number\">7</span>d<span class=\"hljs-number\">45233436</span>\n<span class=\"hljs-attribute\">SecretKey</span>: <span class=\"hljs-number\">560</span>c<span class=\"hljs-number\">52</span>ccd<span class=\"hljs-number\">288</span>fed<span class=\"hljs-number\">045859</span>ed<span class=\"hljs-number\">18</span>bffd<span class=\"hljs-number\">973</span>\n\n<span class=\"hljs-attribute\">Device</span>: android_i\n<span class=\"hljs-attribute\">Description</span>: 国际版\n<span class=\"hljs-attribute\">AppKey</span>: bb<span class=\"hljs-number\">3101000</span>e<span class=\"hljs-number\">232</span>e<span class=\"hljs-number\">27</span>\n<span class=\"hljs-attribute\">SecretKey</span>: <span class=\"hljs-number\">36</span>efcfed<span class=\"hljs-number\">79309338</span>ced<span class=\"hljs-number\">0380</span>abd<span class=\"hljs-number\">824</span>ac<span class=\"hljs-number\">1</span>\n\n<span class=\"hljs-attribute\">Device</span>: android_b\n<span class=\"hljs-attribute\">Description</span>: 概念版\n<span class=\"hljs-attribute\">AppKey</span>: <span class=\"hljs-number\">07</span>da<span class=\"hljs-number\">50</span>c<span class=\"hljs-number\">9</span>a<span class=\"hljs-number\">0</span>bf<span class=\"hljs-number\">829</span>f\n<span class=\"hljs-attribute\">SecretKey</span>: <span class=\"hljs-number\">25</span>bdede<span class=\"hljs-number\">4</span>e<span class=\"hljs-number\">1581</span>c<span class=\"hljs-number\">836</span>cab<span class=\"hljs-number\">73</span>a<span class=\"hljs-number\">48790</span>ca<span class=\"hljs-number\">6</span>e\n\n<span class=\"hljs-attribute\">Device</span>: android_tv\n<span class=\"hljs-attribute\">Description</span>: 电视版\n<span class=\"hljs-attribute\">AppKey</span>: <span class=\"hljs-number\">4409</span>e<span class=\"hljs-number\">2</span>ce<span class=\"hljs-number\">8</span>ffd<span class=\"hljs-number\">12</span>b<span class=\"hljs-number\">8</span>\n<span class=\"hljs-attribute\">SecretKey</span>: <span class=\"hljs-number\">59</span>b<span class=\"hljs-number\">43</span>e<span class=\"hljs-number\">04</span>ad<span class=\"hljs-number\">6965</span>f<span class=\"hljs-number\">34319062</span>b<span class=\"hljs-number\">478</span>f<span class=\"hljs-number\">83</span>dd\n\n<span class=\"hljs-attribute\">Device</span>: biliLink\n<span class=\"hljs-attribute\">Description</span>: 直播\n<span class=\"hljs-attribute\">AppKey</span>: <span class=\"hljs-number\">37207</span>f<span class=\"hljs-number\">2</span>beaebf<span class=\"hljs-number\">8</span>d<span class=\"hljs-number\">7</span>\n<span class=\"hljs-attribute\">SecretKey</span>: e<span class=\"hljs-number\">988</span>e<span class=\"hljs-number\">794</span>d<span class=\"hljs-number\">4</span>d<span class=\"hljs-number\">4</span>b<span class=\"hljs-number\">6</span>dd<span class=\"hljs-number\">43</span>bc<span class=\"hljs-number\">0</span>e<span class=\"hljs-number\">89</span>d<span class=\"hljs-number\">6</span>e<span class=\"hljs-number\">90</span>c<span class=\"hljs-number\">43</span></code></pre>\n<p>（之前因为没ak，sk放弃了）\n那该死的小破站，居然还没有公开OAuth2 （<a href=\"https://passport.bilibili.com/register/third.html\">https://passport.bilibili.com/register/third.html</a>）\n那就只好用安卓客户端的api来玩了</p>\n<p>![V[W9U2M3%5O<code>5N</code>3TDN[Y<a href=\"https://i.loli.net/2019/12/25/9IkbpyWfH3ZaxQh.png\">B.png</a>\n<img src=\"https://i.loli.net/2019/12/25/WIRCULzbswK2rZv.png\" alt=\"0OO07OWUEO{I_OU1L{VXQ2B.png\"></p>\n<p>分别请求了\n<a href=\"https://passport.bilibili.com/api/oauth2/getKey\">https://passport.bilibili.com/api/oauth2/getKey</a> 用于获取加密明文密码用的hash，公钥\n<a href=\"https://passport.bilibili.com/api/v2/oauth2/login\">https://passport.bilibili.com/api/v2/oauth2/login</a> 用于简单的获取用户的登录凭据（access_key、Cookie）\n下面看请求参数\n<img src=\"https://i.loli.net/2019/12/25/sInQoOAdxNuVt6W.png\" alt=\"JG)6MR77DWE@769{~AB1~YH.png\"></p>\n<table>\n<thead>\n<tr>\n<th>参数名</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>appkey</td>\n<td>key</td>\n</tr>\n<tr>\n<td>build</td>\n<td>不知道</td>\n</tr>\n<tr>\n<td>mobi_app</td>\n<td>不知道</td>\n</tr>\n<tr>\n<td>platform</td>\n<td>不知道</td>\n</tr>\n<tr>\n<td>ts</td>\n<td>时间戳</td>\n</tr>\n<tr>\n<td>sign</td>\n<td>签名</td>\n</tr>\n</tbody></table>\n<p>除了sign，没什么好讲的，第二个请求就多了两个参数 username ，password（重要）</p>\n<h3 id=\"返回示例\">返回示例</h3>\n<p><a href=\"https://passport.bilibili.com/api/oauth2/getKey\">https://passport.bilibili.com/api/oauth2/getKey</a></p>\n<pre><code class=\"language-json\">{<span class=\"hljs-string\">&quot;ts&quot;</span>:<span class=\"hljs-number\">1577273591</span>,   <span class=\"hljs-comment\">// 当前UNIX时间戳</span>\n <span class=\"hljs-string\">&quot;code&quot;</span>:<span class=\"hljs-number\">0</span>,          <span class=\"hljs-comment\">//状态码</span>\n <span class=\"hljs-string\">&quot;data&quot;</span>:{\n <span class=\"hljs-string\">&quot;hash&quot;</span>:<span class=\"hljs-string\">&quot;56e15708534f5973&quot;</span>, <span class=\"hljs-comment\">//哈希</span>\n <span class=\"hljs-string\">&quot;key&quot;</span>:<span class=\"hljs-string\">&quot;-----BEGIN PUBLIC KEY-----</span>\n \\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDjb4V7EidX/ym28t2ybo0U6t0n\\n6p4ej8VjqKHg100va6jkNbNTrLQqMCQCAYtXM\n XXp2Fwkk6WR+<span class=\"hljs-number\">12</span>N9zknLjf+C9sx\\n/+l48mjUU8RqahiFD1XT/u2e0m2EN029OhCgkHx3Fc/KlFSIbak93EH/XlYis0w+\\nXl69GV6klz\n gxW6d2xQIDAQAB\\n-----END PUBLIC KEY-----\\n<span class=\"hljs-string\">&quot;   //公钥</span>\n}}</code></pre>\n<p><a href=\"https://passport.bilibili.com/api/v2/oauth2/login\">https://passport.bilibili.com/api/v2/oauth2/login</a></p>\n<pre><code class=\"language-json\">{\n    <span class=\"hljs-attr\">&quot;ts&quot;</span>: <span class=\"hljs-number\">1577278563</span>, <span class=\"hljs-comment\">// 当前UNIX时间戳</span>\n    <span class=\"hljs-attr\">&quot;code&quot;</span>: <span class=\"hljs-number\">0</span>,  <span class=\"hljs-comment\">// 状态码</span>\n    <span class=\"hljs-attr\">&quot;data&quot;</span>: {\n        <span class=\"hljs-attr\">&quot;status&quot;</span>: <span class=\"hljs-number\">0</span>,\n        <span class=\"hljs-attr\">&quot;token_info&quot;</span>: {\n            <span class=\"hljs-attr\">&quot;mid&quot;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-comment\">// 该用户的mid</span>\n            <span class=\"hljs-attr\">&quot;access_token&quot;</span>: <span class=\"hljs-string\">&quot;1234567890abcde1234567890abc&quot;</span>, <span class=\"hljs-comment\">// 该用户的access_key</span>\n            <span class=\"hljs-attr\">&quot;refresh_token&quot;</span>: <span class=\"hljs-string\">&quot;1234567890abcde1234567890abc&quot;</span>, <span class=\"hljs-comment\">// 该用户的refresh_token</span>\n            <span class=\"hljs-attr\">&quot;expires_in&quot;</span>: <span class=\"hljs-number\">2592000</span>             <span class=\"hljs-comment\">// 过期时间戳</span>\n        },\n        <span class=\"hljs-attr\">&quot;cookie_info&quot;</span>: {     <span class=\"hljs-comment\">// 该用户Cookie凭据</span>\n            <span class=\"hljs-attr\">&quot;cookies&quot;</span>: [.....], \n            <span class=\"hljs-attr\">&quot;domains&quot;</span>: [.....]\n        },\n        <span class=\"hljs-attr\">&quot;sso&quot;</span>: [.....]\n    }\n}\n</code></pre>\n<h3 id=\"签名sign生成方式：\">签名(sign)生成方式：</h3>\n<blockquote>\n<p>把接口所需所有参数拼接，如utk=xx&amp;time=xx，按参数名称排序，最后再拼接上密钥App-Secret，做md5加密 (callback不需要参与sign校检)           ------<a href=\"https://github.com/fython/BilibiliAPIDocs\">https://github.com/fython/BilibiliAPIDocs</a></p>\n</blockquote>\n<p>PHP 版本:</p>\n<pre><code class=\"language-php\"><span class=\"hljs-comment\">/**\n * <span class=\"hljs-doctag\">@param</span> $params array 参数列表\n * <span class=\"hljs-doctag\">@param</span> $key 加密密钥\n * <span class=\"hljs-doctag\">@return</span> array sign:加密校验串,params:参数拼接串\n */</span>\n <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">get_sign</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$params</span>, <span class=\"hljs-variable\">$key</span></span>) </span>{\n  <span class=\"hljs-variable\">$_data</span> = <span class=\"hljs-keyword\">array</span>();\n  ksort(<span class=\"hljs-variable\">$params</span>);\n  reset(<span class=\"hljs-variable\">$params</span>);\n  <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-variable\">$params</span> <span class=\"hljs-keyword\">as</span> <span class=\"hljs-variable\">$k</span> =&gt; <span class=\"hljs-variable\">$v</span>) {\n  <span class=\"hljs-comment\">// rawurlencode 返回的转义数字必须为大写( 如%2F )</span>\n  <span class=\"hljs-variable\">$_data</span>[] = <span class=\"hljs-variable\">$k</span> . <span class=\"hljs-string\">&#x27;=&#x27;</span> . rawurlencode(<span class=\"hljs-variable\">$v</span>);\n  }\n  <span class=\"hljs-variable\">$_sign</span> = implode(<span class=\"hljs-string\">&#x27;&amp;&#x27;</span>, <span class=\"hljs-variable\">$_data</span>);\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">array</span>(\n    <span class=\"hljs-string\">&#x27;sign&#x27;</span> =&gt; strtolower(md5(<span class=\"hljs-variable\">$_sign</span> . <span class=\"hljs-variable\">$key</span>)),\n    <span class=\"hljs-string\">&#x27;params&#x27;</span> =&gt; <span class=\"hljs-variable\">$_sign</span>,\n  );\n }\n define(<span class=\"hljs-string\">&quot;APP_SECRET&quot;</span>,<span class=\"hljs-string\">&quot;abcdef123456&quot;</span>);\n get_sign(<span class=\"hljs-keyword\">array</span>(<span class=\"hljs-string\">&quot;type&quot;</span>=&gt;<span class=\"hljs-string\">&quot;json&quot;</span>),APP_SECRET);</code></pre>\n<p>js版本:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;text/javascript&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;http://static.hdslb.com/js/md5.js&quot;</span>&gt;</span><span class=\"javascript\">/script&gt;\n <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">get_sign</span>(<span class=\"hljs-params\">params, key</span>)\n </span>{\n     <span class=\"hljs-keyword\">var</span> s_keys = [];\n     <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i <span class=\"hljs-keyword\">in</span> params)\n     {\n         s_keys.push(i);\n     }\n     s_keys.sort();\n     <span class=\"hljs-keyword\">var</span> data = <span class=\"hljs-string\">&quot;&quot;</span>;\n     <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; s_keys.length; i++)\n     {\n         <span class=\"hljs-comment\">// encodeURIComponent 返回的转义数字必须为大写( 如 %2F )</span>\n         data+=(data ? <span class=\"hljs-string\">&quot;&amp;&quot;</span> : <span class=\"hljs-string\">&quot;&quot;</span>)+s_keys[i]+<span class=\"hljs-string\">&quot;=&quot;</span>+<span class=\"hljs-built_in\">encodeURIComponent</span>(params[s_keys[i]]);\n     }\n     <span class=\"hljs-keyword\">return</span> {\n         <span class=\"hljs-string\">&quot;sign&quot;</span>:hex_md5(data+key),\n         <span class=\"hljs-string\">&quot;params&quot;</span>:data\n     };\n }</span></code></pre>\n<h3 id=\"password-生成方式\">password 生成方式</h3>\n<p>在明文密码前拼接从<a href=\"https://passport.bilibili.com/api/oauth2/getKey%E5%BE%97%E6%9D%A5%E7%9A%84hash%EF%BC%8C%E7%94%A8%E5%BE%97%E6%9D%A5%E7%9A%84%E5%85%AC%E9%92%A5%E5%81%9Arsa%E5%8A%A0%E5%AF%86%E5%86%8Dbase64\">https://passport.bilibili.com/api/oauth2/getKey得来的hash，用得来的公钥做rsa加密再base64</a></p>\n<pre><code class=\"language-php\">/**\n * @param <span class=\"hljs-variable\">$key</span> 加密公钥\n * @param <span class=\"hljs-variable\">$hash</span><span class=\"hljs-built_in\"> string</span> 哈希\n * @param <span class=\"hljs-variable\">$pwd</span><span class=\"hljs-built_in\"> string</span> 明文密码\n * @<span class=\"hljs-keyword\">return</span><span class=\"hljs-built_in\"> string</span> base64后的加密密码\n */\n\n<span class=\"hljs-keyword\">function</span> get_rsa_pwd(<span class=\"hljs-variable\">$key</span>,<span class=\"hljs-variable\">$hash</span>,<span class=\"hljs-variable\">$pwd</span>) {\n        <span class=\"hljs-variable\">$pu_key</span> = openssl_pkey_get_public(<span class=\"hljs-variable\">$key</span>);\n        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$loginkey</span>) {\n            openssl_public_encrypt(<span class=\"hljs-variable\">$hash</span> . <span class=\"hljs-variable\">$pwd</span> ,<span class=\"hljs-variable\">$rsa_pwd</span>,<span class=\"hljs-variable\">$pu_key</span>);\n            <span class=\"hljs-keyword\">return</span> base64_encode(<span class=\"hljs-variable\">$rsa_pwd</span>);\n        } <span class=\"hljs-keyword\">else</span> {\n            <span class=\"hljs-keyword\">return</span><span class=\"hljs-built_in\"> false</span> ;\n        }\n    }</code></pre>\n<p>这些都知道了，你还写不出来登录？？</p>\n<h3 id=\"demo\">demo</h3>\n<pre><code>https:<span class=\"hljs-regexp\">//</span>nworm.cf<span class=\"hljs-regexp\">/my/</span>bili/login.php?user=a&amp;pwd=b\n参数都懂吧\n我不会记录账号密码，也没有必要\n不相信我的，请使用小号</code></pre>\n<h3 id=\"源码\">源码</h3>\n<p><a href=\"https://github.com/1574242600/bili-login\">https://github.com/1574242600/bili-login</a>\n我没写判断</p>\n<h3 id=\"关于验证码的问题\">关于验证码的问题</h3>\n<p>关于验证码的问题\n<a href=\"https://passport.bilibili.com/captcha\">https://passport.bilibili.com/captcha</a>\n在请求b站登录api（或demo，不过demo的sid的值请自行解析，我懒）时，它会返回一个cookies， 名称为sid\n带着sid请求上面的链接，得到验证码图片，和名为JSESSIONID的session\n最后带着上面的cookies ，再加个请求参数captcha，值就是验证码\n就行了</p>\n<h3 id=\"坑\">坑</h3>\n<pre><code>curl<span class=\"hljs-constructor\">_setopt($<span class=\"hljs-params\">lo</span>, CURLOPT_POSTFIELDS,$<span class=\"hljs-params\">data</span>)</span>;</code></pre>\n<pre><code>curl<span class=\"hljs-constructor\">_setopt($<span class=\"hljs-params\">lo</span>, CURLOPT_POSTFIELDS,<span class=\"hljs-params\">http_build_query</span>($<span class=\"hljs-params\">data</span>)</span>);</code></pre>\n<p>区别：<a href=\"https://www.cnblogs.com/52php/p/5677689.html\">https://www.cnblogs.com/52php/p/5677689.html</a>\n(会导致b站认为你的请求非法)\n这玩意害我蒙了半天\n以后我绝对加http_build_query()</p>\n","nav":[[3,"返回示例"],[3,"签名(sign)生成方式："],[3,"password 生成方式"],[3,"demo"],[3,"源码"],[3,"关于验证码的问题"],[3,"坑"]]}